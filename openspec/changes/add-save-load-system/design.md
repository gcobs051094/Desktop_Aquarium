# Design: 遊戲狀態儲存與載入系統

## Context
- 程式將打包為 exe，使用者會直接替換 exe 檔案來更新
- 程式會頻繁更新新內容（魚種、寵物、飼料、大便等）
- 必須確保舊版本存檔在新版本中能正常載入
- 存檔應與程式檔案分離，避免更新時被覆蓋

## Goals / Non-Goals

### Goals
- 實現遊戲狀態的持久化儲存
- 確保版本間存檔格式向後相容
- 存檔位置獨立於程式檔案
- 自動儲存與載入機制
- 支援解鎖狀態追蹤

### Non-Goals
- 不實作多個存檔槽位（未來可擴展）
- 不實作存檔加密（未來可擴展）
- 不實作雲端同步（未來可擴展）

## Decisions

### Decision: 使用 JSON 格式儲存
**理由**：
- JSON 是人類可讀的格式，便於除錯
- Python 標準庫原生支援，無需額外依賴
- 結構化資料易於擴展
- 向後相容處理相對簡單

**替代方案**：
- SQLite：過於複雜，單一使用者單一存檔不需要資料庫
- Pickle：不安全且版本相容性差
- 自訂二進位格式：開發成本高，除錯困難

### Decision: 存檔位置使用使用者資料目錄
**理由**：
- Windows: `%APPDATA%/Desktop_Feeding_Fish/save.json`
- 與程式檔案分離，更新 exe 不會影響存檔
- 符合 Windows 應用程式慣例
- 使用 `pathlib` 和 `os` 模組自動處理路徑

**替代方案**：
- 程式目錄：更新時可能被覆蓋
- 註冊表：不適合儲存大量結構化資料

### Decision: 版本號機制
**理由**：
- 存檔格式包含 `version` 欄位（字串，如 "1.0.0"）
- 新版本讀取舊存檔時，根據版本號決定遷移策略
- 未知欄位自動忽略，已知欄位缺失時使用預設值
- 確保向後相容性

**遷移策略**：
- 版本號相同：直接載入
- 版本號較舊：執行遷移函數（目前為空，未來可擴展）
- 未知欄位：忽略
- 缺失欄位：使用預設值

### Decision: 儲存時機
**理由**：
- **自動儲存**：關鍵狀態變更時（魚類新增/移除、金額變更、解鎖狀態變更）
- **關閉時儲存**：程式關閉事件（`closeEvent`）時執行最後一次儲存
- 不實作定期自動儲存（避免頻繁寫入）

**儲存觸發點**：
- 新增魚類時
- 移除魚類時（升級、死亡等）
- 金額變更時
- 解鎖狀態變更時
- 程式關閉時

### Decision: 遊戲狀態資料結構
```python
{
    "version": "1.0.0",
    "money": 0,
    "unlocked_species": {
        "guppy": {
            "max_count_reached": 0,  # 曾經達到過的最大數量
            "unlocked": True  # 是否已解鎖（基於 max_count_reached）
        }
    },
    "fishes": [
        {
            "species": "guppy",
            "stage": "small",
            "growth_points": 5,
            "position": {"x": 100, "y": 200},
            "direction": 0.5,
            "facing_left": True
        }
    ],
    "background_path": "resource/background/bg1.png",  # 相對路徑或 None
    "background_opacity": 80
}
```

**設計考量**：
- `fishes` 陣列儲存所有魚類的完整狀態
- `unlocked_species` 記錄解鎖資訊
- `version` 用於版本相容性檢查
- 路徑使用相對路徑或資源名稱，避免絕對路徑問題

## Risks / Trade-offs

### Risk: 存檔損壞導致無法載入
**緩解**：
- 載入前驗證 JSON 格式
- 載入失敗時使用預設狀態，不中斷程式啟動
- 記錄錯誤日誌

### Risk: 版本更新導致存檔格式不相容
**緩移**：
- 使用版本號機制
- 未知欄位自動忽略
- 缺失欄位使用預設值
- 未來可實作遷移函數

### Risk: 頻繁自動儲存影響效能
**緩解**：
- 只在關鍵狀態變更時儲存
- 使用非同步寫入（未來可擴展）
- 關閉時才確保寫入完成

### Trade-off: 儲存完整魚類狀態 vs 僅儲存必要資訊
**選擇**：儲存完整狀態，包括位置、方向等，確保載入後完全恢復
**理由**：使用者期望關閉後重開能完全恢復，包括魚的位置和行為狀態

## Migration Plan

### Phase 1: 基礎架構
1. 創建 `game_state.py` 模組
2. 定義存檔格式和版本號
3. 實作基本儲存/載入功能

### Phase 2: 整合
1. 在 `aquarium_window.py` 整合儲存/載入
2. 實作自動儲存觸發點
3. 實作程式關閉時儲存

### Phase 3: 解鎖追蹤
1. 新增解鎖狀態追蹤機制
2. 在魚類數量變更時更新解鎖狀態

### Phase 4: 測試與驗證
1. 測試存檔載入/儲存
2. 測試版本相容性
3. 測試存檔損壞處理

## Open Questions
- [ ] 是否需要支援多個存檔槽位？（目前單一存檔）
- [ ] 是否需要存檔備份機制？（目前無）
- [ ] 魚類位置是否應該儲存？（目前是，確保完全恢復）
