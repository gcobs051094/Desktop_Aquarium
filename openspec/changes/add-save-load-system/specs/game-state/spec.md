# Game State Management Specification

## ADDED Requirements

### Requirement: 遊戲狀態持久化儲存
系統 SHALL 提供遊戲狀態的持久化儲存功能，將當前遊戲狀態儲存到檔案系統，包括：
- 水族箱內所有魚類的狀態（魚種、成長階段、成長度、位置、方向等）
- 當前金額總計
- 解鎖魚種的狀態（曾經達到過的最大數量、是否已解鎖）
- 背景圖片路徑與透明度設定

#### Scenario: 儲存遊戲狀態
- **WHEN** 遊戲狀態發生變更（新增魚類、移除魚類、金額變更、解鎖狀態變更）或程式關閉時
- **THEN** 系統自動將當前遊戲狀態寫入存檔檔案

#### Scenario: 載入遊戲狀態
- **WHEN** 程式啟動時
- **THEN** 系統自動從存檔檔案載入遊戲狀態，恢復到上次關閉時的狀態

#### Scenario: 首次啟動無存檔
- **WHEN** 程式首次啟動且存檔檔案不存在時
- **THEN** 系統使用預設遊戲狀態（空水族箱、金額為 0、無解鎖魚種）

### Requirement: 存檔位置獨立於程式檔案
系統 SHALL 將存檔檔案存放在使用者資料目錄，與程式檔案分離，確保打包為 exe 後更新程式檔案不會影響存檔。

#### Scenario: Windows 平台存檔位置
- **WHEN** 在 Windows 平台執行時
- **THEN** 存檔檔案位於 `%APPDATA%/Desktop_Feeding_Fish/save.json`

#### Scenario: 程式更新不影響存檔
- **WHEN** 使用者替換 exe 檔案更新程式時
- **THEN** 存檔檔案保持不變，新版本程式能正常載入舊存檔

### Requirement: 存檔格式版本相容性
系統 SHALL 使用版本號機制確保存檔格式的向後相容性，新版本程式必須能讀取舊版本存檔。

#### Scenario: 存檔包含版本號
- **WHEN** 儲存遊戲狀態時
- **THEN** 存檔檔案包含 `version` 欄位，標示存檔格式版本（如 "1.0.0"）

#### Scenario: 新版本讀取舊存檔
- **WHEN** 新版本程式載入舊版本存檔時
- **THEN** 系統根據版本號執行適當的遷移邏輯，或使用預設值處理缺失欄位，確保存檔能正常載入

#### Scenario: 未知欄位處理
- **WHEN** 載入存檔時遇到未知欄位（未來版本新增的欄位）
- **THEN** 系統忽略未知欄位，不影響載入過程

#### Scenario: 缺失欄位處理
- **WHEN** 載入存檔時遇到缺失欄位（舊版本未儲存的欄位）
- **THEN** 系統使用預設值填充缺失欄位，確保程式正常運行

### Requirement: 解鎖狀態追蹤
系統 SHALL 追蹤使用者曾經達到過的魚種數量里程碑，用於判斷魚種是否已解鎖。

#### Scenario: 記錄魚種最大數量
- **WHEN** 水族箱內某魚種的數量達到新的最大值時
- **THEN** 系統更新該魚種的 `max_count_reached` 記錄

#### Scenario: 解鎖狀態判定
- **WHEN** 檢查魚種是否已解鎖時
- **THEN** 系統根據 `max_count_reached` 與解鎖條件（未來商店系統使用）判定解鎖狀態

#### Scenario: 解鎖狀態持久化
- **WHEN** 儲存遊戲狀態時
- **THEN** 系統將所有魚種的解鎖狀態（包括 `max_count_reached` 和 `unlocked`）寫入存檔

### Requirement: 自動儲存機制
系統 SHALL 在關鍵狀態變更時自動儲存遊戲狀態，無需使用者手動操作。

#### Scenario: 魚類新增時自動儲存
- **WHEN** 使用者新增魚類到水族箱時
- **THEN** 系統自動觸發儲存操作

#### Scenario: 魚類移除時自動儲存
- **WHEN** 魚類被移除（升級、死亡等）時
- **THEN** 系統自動觸發儲存操作

#### Scenario: 金額變更時自動儲存
- **WHEN** 使用者拾取金錢導致金額變更時
- **THEN** 系統自動觸發儲存操作

#### Scenario: 程式關閉時儲存
- **WHEN** 使用者關閉程式時
- **THEN** 系統執行最後一次儲存操作，確保所有變更都被保存

### Requirement: 錯誤處理與恢復
系統 SHALL 在存檔載入失敗時優雅處理錯誤，不中斷程式啟動。

#### Scenario: 存檔檔案損壞
- **WHEN** 存檔檔案格式錯誤或無法解析時
- **THEN** 系統使用預設遊戲狀態，記錄錯誤訊息，程式正常啟動

#### Scenario: 存檔檔案不存在
- **WHEN** 首次啟動或存檔檔案被刪除時
- **THEN** 系統使用預設遊戲狀態，程式正常啟動

#### Scenario: 儲存失敗處理
- **WHEN** 儲存操作失敗（如磁碟空間不足、權限問題）時
- **THEN** 系統記錄錯誤訊息，不中斷程式運行，下次狀態變更時再次嘗試儲存
